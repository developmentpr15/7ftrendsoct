# üìã Profiles API Documentation

## Overview
The profiles table stores user profile information and is linked to Supabase Auth users table. This document outlines the expected request/response format for profile creation and management.

## üóÑÔ∏è Database Schema

### **Profiles Table Structure**
```sql
CREATE TABLE public.profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4() NOT NULL,        -- Auto-generated UUID
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,          -- Links to auth.users
    username TEXT UNIQUE NOT NULL,                                     -- Unique username
    full_name TEXT,                                                    -- Display name
    avatar_url TEXT,                                                   -- Profile picture URL
    bio TEXT,                                                         -- User bio/description
    email TEXT,                                                        -- User email
    country_code TEXT,                                                 -- Country code (ISO format)
    timezone TEXT,                                                      -- User timezone
    is_public BOOLEAN DEFAULT TRUE NOT NULL,                        -- Profile visibility
    preferences JSONB DEFAULT '{}'::jsonb NOT NULL,                  -- User preferences
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,                     -- Creation timestamp
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL                      -- Last update timestamp
);
```

### **Key Points:**
- ‚úÖ **`id`**: Auto-generated by database using `uuid_generate_v4()`
- ‚úÖ **`user_id`**: Links to `auth.users(id)` for authentication
- ‚úÖ **`username`**: Must be unique, converted to lowercase
- ‚úÖ **RLS Policies**: Users can only access their own profile or public profiles

## üîß API Endpoints

### **1. Create User Profile**
**Endpoint**: `POST /rest/v1/profiles`

**Request Body**:
```json
{
  "user_id": "uuid-from-auth-users",
  "username": "john_doe",
  "full_name": "John Doe",
  "bio": "Fashion enthusiast and style curator",
  "country_code": "US",
  "timezone": "America/New_York",
  "is_public": true,
  "preferences": {
    "style_preferences": {
      "colors": ["Black", "White", "Blue"],
      "styles": ["Casual", "Business"],
      "occasions": ["Work", "Weekend"]
    },
    "size_preferences": {
      "tops": "M",
      "bottoms": "32",
      "shoes": "10"
    },
    "notification_settings": {
      "new_followers": true,
      "competition_updates": true,
      "outfit_suggestions": true,
      "friend_activities": true
    }
  }
}
```

**Response (201 Created)**:
```json
{
  "id": "auto-generated-uuid-here",
  "user_id": "uuid-from-auth-users",
  "username": "john_doe",
  "full_name": "John Doe",
  "bio": "Fashion enthusiast and style curator",
  "country_code": "US",
  "timezone": "America/New_York",
  "is_public": true,
  "preferences": {
    "style_preferences": {
      "colors": ["Black", "White", "Blue"],
      "styles": ["Casual", "Business"],
      "occasions": ["Work", "Weekend"]
    },
    "size_preferences": {
      "tops": "M",
      "bottoms": "32",
      "shoes": "10"
    },
    "notification_settings": {
      "new_followers": true,
      "competition_updates": true,
      "outfit_suggestions": true,
      "friend_activities": true
    }
  },
  "created_at": "2024-01-20T10:30:00.000Z",
  "updated_at": "2024-01-20T10:30:00.000Z"
}
```

### **2. Get User Profile**
**Endpoint**: `GET /rest/v1/profiles?user_id=eq.{user_id}`

**Response (200 OK)**:
```json
{
  "id": "auto-generated-uuid-here",
  "user_id": "uuid-from-auth-users",
  "username": "john_doe",
  "full_name": "John Doe",
  "avatar_url": "https://example.com/avatar.jpg",
  "bio": "Fashion enthusiast and style curator",
  "country_code": "US",
  "timezone": "America/New_York",
  "is_public": true,
  "preferences": { ... },
  "created_at": "2024-01-20T10:30:00.000Z",
  "updated_at": "2024-01-20T10:30:00.000Z"
}
```

### **3. Update User Profile**
**Endpoint**: `PATCH /rest/v1/profiles?user_id=eq.{user_id}`

**Request Body**:
```json
{
  "full_name": "John Smith",
  "bio": "Updated bio",
  "preferences": {
    "style_preferences": {
      "colors": ["Black", "Red", "Blue"]
    }
  }
}
```

### **4. Delete User Profile**
**Endpoint**: `DELETE /rest/v1/profiles?user_id=eq.{user_id}`

**Response**: 204 No Content

## üîê Security & Permissions

### **Row Level Security (RLS) Policies**

#### **1. View Profiles**
```sql
CREATE POLICY "Users can view profiles" ON public.profiles
    FOR SELECT USING (
        auth.uid() = id OR
        auth.uid() = user_id OR
        is_public = TRUE
    );
```

#### **2. Insert Profiles**
```sql
CREATE POLICY "Users can insert own profile" ON public.profiles
    FOR INSERT WITH CHECK (
        auth.uid() = id OR
        auth.uid() = user_id
    );
```

#### **3. Update Profiles**
```sql
CREATE POLICY "Users can update own profile" ON public.profiles
    FOR UPDATE USING (
        auth.uid() = id OR
        auth.uid() = user_id
    );
```

#### **4. Delete Profiles**
```sql
CREATE POLICY "Users can delete own profile" ON public.profiles
    FOR DELETE USING (
        auth.uid() = id OR
        auth.uid() = user_id
    );
```

## üì± Frontend Integration

### **TypeScript Interface**
```typescript
interface OnboardingData {
  username: string;
  full_name?: string;
  bio?: string;
  country_code?: string;
  timezone?: string;
  is_public?: boolean;
  style_preferences?: Record<string, any>;
  size_preferences?: Record<string, any>;
  notification_settings?: {
    new_followers?: boolean;
    competition_updates?: boolean;
    outfit_suggestions?: boolean;
    friend_activities?: boolean;
  };
}

interface UserProfile {
  id: string;
  user_id: string;
  username: string;
  full_name?: string;
  avatar_url?: string;
  bio?: string;
  email?: string;
  country_code?: string;
  timezone?: string;
  is_public: boolean;
  preferences: {
    style_preferences: Record<string, any>;
    size_preferences: Record<string, any>;
    notification_settings: {
      new_followers: boolean;
      competition_updates: boolean;
      outfit_suggestions: boolean;
      friend_activities: boolean;
    };
  };
  created_at: string;
  updated_at: string;
}
```

### **Service Method Example**
```typescript
async createUserProfile(userId: string, onboardingData: OnboardingData): Promise<UserProfile | null> {
  try {
    // Validate username uniqueness
    const isAvailable = await this.checkUsernameAvailability(onboardingData.username);
    if (!isAvailable) {
      throw new Error('Username is already taken');
    }

    // Prepare profile data (id is auto-generated by database)
    const profileData = {
      user_id: userId, // Links to auth.users
      username: onboardingData.username.toLowerCase(),
      full_name: onboardingData.full_name || '',
      bio: onboardingData.bio || '',
      country_code: onboardingData.country_code,
      timezone: onboardingData.timezone,
      is_public: onboardingData.is_public ?? true,
      preferences: {
        style_preferences: onboardingData.style_preferences || {},
        size_preferences: onboardingData.size_preferences || {},
        notification_settings: onboardingData.notification_settings || {
          new_followers: true,
          competition_updates: true,
          outfit_suggestions: true,
          friend_activities: true,
        },
      },
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    };

    // Insert into database
    const { data, error } = await supabase
      .from('profiles')
      .insert(profileData)
      .select()
      .single();

    if (error) throw error;

    return data as UserProfile;
  } catch (error) {
    console.error('Error creating user profile:', error);
    throw error;
  }
}
```

## ‚ö†Ô∏è Error Handling

### **Common Errors & Solutions**

#### **1. "null value in column 'id' violates not-null constraint"**
- **Cause**: Trying to manually set `id` field
- **Solution**: Remove `id` from request body - let database auto-generate it

#### **2. "duplicate key value violates unique constraint 'profiles_username_key'"**
- **Cause**: Username already exists
- **Solution**: Check username availability before creating profile

#### **3. "foreign key constraint violation"**
- **Cause**: `user_id` doesn't exist in `auth.users`
- **Solution**: Ensure user is authenticated before creating profile

#### **4. "new row for relation 'profiles' violates row-level security policy"**
- **Cause**: RLS policy violation
- **Solution**: Ensure user is properly authenticated

## üß™ Testing

### **Test Cases**

1. **Valid Profile Creation**
   ```javascript
   const onboardingData = {
     username: "testuser123",
     full_name: "Test User",
     country_code: "US"
   };

   const profile = await authService.createUserProfile(userId, onboardingData);
   expect(profile.id).toBeDefined();
   expect(profile.username).toBe("testuser123");
   ```

2. **Invalid Profile Creation (Missing Username)**
   ```javascript
   const onboardingData = {
     full_name: "Test User"
     // Missing username - should throw error
   };

   await expect(authService.createUserProfile(userId, onboardingData))
     .rejects.toThrow('Username is required');
   ```

3. **Duplicate Username**
   ```javascript
   // Create first profile
   await authService.createUserProfile(userId1, { username: "testuser" });

   // Try to create second profile with same username
   await expect(authService.createUserProfile(userId2, { username: "testuser" }))
     .rejects.toThrow('Username is already taken');
   ```

4. **Auto-Generated ID**
   ```javascript
   const profile = await authService.createUserProfile(userId, data);

   // ID should be auto-generated and valid UUID
   expect(profile.id).toMatch(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i);

   // Should not be the userId passed in
   expect(profile.id).not.toBe(userId);
   ```

## üìä Performance Considerations

### **Indexes**
- `profiles_username_idx` - For username lookups
- `profiles_user_id_idx` - For auth user lookups
- `profiles_email_idx` - For email lookups
- `profiles_country_idx` - For country-based queries
- `profiles_is_public_idx` - For public profile visibility

### **Query Optimization**
```sql
-- Optimize for current user's profile
SELECT * FROM profiles WHERE user_id = auth.uid();

-- Optimize for username lookup
SELECT * FROM profiles WHERE username = 'username';

-- Optimize for public profiles
SELECT * FROM profiles WHERE is_public = TRUE;
```

## üîó Related Files

- `src/services/authService.ts` - Profile creation service
- `src/components/auth/OnboardingFlow.js` - Onboarding UI
- `src/types/auth.ts` - Type definitions
- Database schema files - SQL migration scripts